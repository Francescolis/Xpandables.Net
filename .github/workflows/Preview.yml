name: PR Release Preview

on:
  pull_request:
    branches:
      - main
      - 'release/*'
    types: [opened, synchronize, reopened]

jobs:
  preview:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find last tag
        id: last_tag
        run: |
          tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
          echo "last_tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Calculate next version from PR commits
        id: version
        run: |
          last_tag="${{ steps.last_tag.outputs.last_tag }}"
          base="${last_tag#v}"
          major=$(echo "$base" | cut -d. -f1)
          minor=$(echo "$base" | cut -d. -f2)
          patch=$(echo "$base" | cut -d. -f3)

          range="${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}"
          log=$(git log --format=%B $range || true)

          release_type="patch"
          if echo "$log" | grep -qE "BREAKING CHANGE|feat!|fix!"; then
            release_type="major"
          elif echo "$log" | grep -qE "^feat(\(|:)|^feat!"; then
            release_type="minor"
          fi

          if [ "$release_type" = "major" ]; then
            major=$((major + 1))
            minor=0
            patch=0
          elif [ "$release_type" = "minor" ]; then
            minor=$((minor + 1))
            patch=0
          else
            patch=$((patch + 1))
          fi

          new_version="$major.$minor.$patch"

          echo "release_type=$release_type" >> "$GITHUB_OUTPUT"
          echo "version=$new_version" >> "$GITHUB_OUTPUT"

      - name: Comment on PR with preview
        uses: actions/github-script@v7
        with:
          script: |
            const version = "${{ steps.version.outputs.version }}";
            const type = "${{ steps.version.outputs.release_type }}";
            const body = `
**Release preview**

If this PR is merged into \`${{ github.base_ref }}\`, the next calculated version would be:

- Version: \`${version}\`
- Change type: \`${type}\` (major/minor/patch)

Based on Conventional Commit markers in this PR's commits.
`;
            await github.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
